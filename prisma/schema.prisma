generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  email             String?            @unique
  password          String
  nickname          String?
  role              String             @default("STUDENT")
  avatar            String?
  createdAt         DateTime           @default(now())
  name              String?
  status            String             @default("ACTIVE") // æ·»åŠ çŠ¶æ€å­—æ®µ
  courses           Course[]
  certificates      Certificate[]
  visitLogs         VisitLog[]
  studyLogs         StudyLog[]
  resourceDownloads ResourceDownload[]
}

model Course {
  id           Int           @id @default(autoincrement())
  title        String        @unique // ğŸ‘ˆ æ”¹ä¸º title
  description  String?
  cover        String?
  teacherId    Int?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt // å»ºè®®åŠ ä¸Š
  teacher      User?         @relation(fields: [teacherId], references: [id])
  category     String?
  certificates Certificate[]
  studyLogs    StudyLog[]
}

model PublishedExam {
  id           Int            @id @default(autoincrement())
  title        String
  subject      String
  difficulty   String
  questionType String
  createdAt    DateTime       @default(now())
  createdBy    String
  status       String         @default("active")
  questions    ExamQuestion[]
}

model ExamQuestion {
  id              Int            @id @default(autoincrement())
  question        String
  answer          String
  explanation     String?
  createdAt       DateTime       @default(now())
  subject         String
  difficulty      String
  questionType    String
  options         Json
  optionsHash     String? // å¯é€‰ï¼Œä½†æ¨è
  publishedExam   PublishedExam? @relation(fields: [publishedExamId], references: [id])
  publishedExamId Int?
  isCurrentExam   Boolean        @default(false) // ğŸ‘ˆ æ–°å¢å­—æ®µï¼

  @@index([subject, difficulty, questionType])
  @@index([isCurrentExam]) // ğŸ‘ˆ åŠ ç´¢å¼•ï¼ŒæŸ¥è¯¢æ›´å¿«
}

model ExamTemplate {
  id       Int           @id @default(autoincrement())
  name     String        @unique
  duration Int
  sections ExamSection[]
}

model ExamSection {
  id           Int          @id @default(autoincrement())
  questionType String
  count        Int
  score        Int
  template     ExamTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId   Int
}

model Certificate {
  id         Int      @id @default(autoincrement())
  name       String? // è¯ä¹¦åç§°
  username   String // å­¦å‘˜å§“å
  courseId   Int?
  courseName String? // è¯¾ç¨‹å
  issuedAt   DateTime @default(now())
  status     String?  @default("ACTIVE") // ACTIVE, EXPIRED
  userId     Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  templateId Int
  // å…³è”å…³ç³»
  user       User?    @relation(fields: [userId], references: [id])
  course     Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
}

model VisitLog {
  id         Int      @id @default(autoincrement())
  userId     Int? // å¯å…³è”å·²ç™»å½•ç”¨æˆ·
  ip         String?
  userAgent  String?
  path       String // å¦‚ /api/courses, /dashboard
  method     String // GET, POST...
  statusCode Int // 200, 404...
  duration   Int? // å“åº”è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([path, createdAt])
}

model StudyLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int?
  lessonId  Int? // å¦‚æœæœ‰ lesson æ¨¡å‹
  action    String // "watch_video", "complete_lesson", "start_exam", "download_resource"
  metadata  Json? // é¢å¤–ä¿¡æ¯ { videoId: 123, progress: 80 }
  duration  Int? // å­¦ä¹ æ—¶é•¿ï¼ˆç§’ï¼‰
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  course Course? @relation(fields: [courseId], references: [id])

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

model ResourceDownload {
  id           Int      @id @default(autoincrement())
  userId       Int
  resourceId   Int // å¯æŒ‡å‘è¯¾ç¨‹èµ„æ–™ã€é™„ä»¶ç­‰
  resourceType String // "course_material", "certificate_pdf", "exam_template"
  fileName     String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([resourceType, createdAt])
}

// prisma/schema.prisma

model PageView {
  id       Int      @id @default(autoincrement())
  ip       String?
  userId   Int?
  path     String // é¡µé¢è·¯å¾„ï¼Œå¦‚ "/"
  viewedAt DateTime @default(now())

  @@index([viewedAt])
  @@index([ip])
  @@index([userId])
}
