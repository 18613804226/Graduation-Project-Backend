generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int                @id @default(autoincrement())
  username          String             @unique
  email             String?            @unique
  password          String?
  nickname          String?
  role              String             @default("STUDENT")
  avatar            String?
  createdAt         DateTime           @default(now())
  name              String?
  status            String             @default("ACTIVE") // æ·»åŠ çŠ¶æ€å­—æ®µ
  courses           Course[]
  certificates      Certificate[]
  visitLogs         VisitLog[]
  studyLogs         StudyLog[]
  resourceDownloads ResourceDownload[]
  examResults       ExamResult[]
  activityLogs      ActivityLog[]
  lessonProgresses  LessonProgress[]
  notifications     Notification[]
}

model Course {
  id            Int            @id @default(autoincrement())
  title         String         @unique // ğŸ‘ˆ æ”¹ä¸º title
  description   String?
  cover         String?
  teacherId     Int?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt // å»ºè®®åŠ ä¸Š
  teacher       User?          @relation(fields: [teacherId], references: [id])
  category      String?
  certificates  Certificate[]
  studyLogs     StudyLog[]
  examTemplates ExamTemplate[]
  lessons       Lesson[]
}

model PublishedExam {
  id          Int            @id @default(autoincrement())
  title       String
  subject     String
  difficulty  String
  createdAt   DateTime       @default(now())
  createdBy   String
  status      String         @default("active")
  isCurrent   Boolean        @default(false) // âœ… mark current exam
  templateId  Int?
  template    ExamTemplate?  @relation(fields: [templateId], references: [id])
  questions   ExamQuestion[]
  duration    Int            @default(0) // âœ… å†—ä½™å­˜å‚¨è€ƒè¯•æ—¶é•¿
  examResults ExamResult[]

  @@index([isCurrent]) // âœ… faster lookup for current exam
}

model ExamQuestion {
  id              Int            @id @default(autoincrement())
  question        String
  answer          String
  explanation     String?
  createdAt       DateTime       @default(now())
  subject         String
  difficulty      String
  questionType    String
  options         Json
  score           Int            @default(10)
  publishedExamId Int?
  publishedExam   PublishedExam? @relation(fields: [publishedExamId], references: [id])
  isCurrentExam   Boolean        @default(false) // âœ… åŠ è¿™ä¸€è¡Œ
  optionsHash     String? // âœ… æ·»åŠ è¿™ä¸€è¡Œ

  @@index([publishedExamId])
}

model ExamTemplate {
  id           Int             @id @default(autoincrement())
  name         String          @unique
  duration     Int
  sections     ExamSection[]
  courseId     Int?
  exams        PublishedExam[] // optional back-reference
  course       Course?         @relation(fields: [courseId], references: [id])
  passingScore Int?            @default(60) // âœ… æ–°å¢å­—æ®µ
}

model ExamSection {
  id           Int          @id @default(autoincrement())
  questionType String
  count        Int
  score        Int
  templateId   Int
  template     ExamTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
}

model Certificate {
  id         Int      @id @default(autoincrement())
  name       String? // è¯ä¹¦åç§°
  username   String // å­¦å‘˜å§“å
  courseId   Int?
  courseName String? // è¯¾ç¨‹å
  issuedAt   DateTime @default(now())
  status     String?  @default("ACTIVE") // ACTIVE, EXPIRED
  userId     Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  templateId Int
  // å…³è”å…³ç³»
  user       User?    @relation(fields: [userId], references: [id])
  course     Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
}

model VisitLog {
  id         Int      @id @default(autoincrement())
  userId     Int? // å¯å…³è”å·²ç™»å½•ç”¨æˆ·
  ip         String?
  userAgent  String?
  path       String // å¦‚ /api/courses, /dashboard
  method     String // GET, POST...
  statusCode Int // 200, 404...
  duration   Int? // å“åº”è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([path, createdAt])
}

model StudyLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int?
  lessonId  Int? // å¦‚æœæœ‰ lesson æ¨¡å‹
  action    String // "watch_video", "complete_lesson", "start_exam", "download_resource"
  metadata  Json? // é¢å¤–ä¿¡æ¯ { videoId: 123, progress: 80 }
  duration  Int? // å­¦ä¹ æ—¶é•¿ï¼ˆç§’ï¼‰
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  course Course? @relation(fields: [courseId], references: [id])

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

model ResourceDownload {
  id           Int      @id @default(autoincrement())
  userId       Int
  resourceId   Int // å¯æŒ‡å‘è¯¾ç¨‹èµ„æ–™ã€é™„ä»¶ç­‰
  resourceType String // "course_material", "certificate_pdf", "exam_template"
  fileName     String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([resourceType, createdAt])
}

// prisma/schema.prisma

model PageView {
  id       Int      @id @default(autoincrement())
  ip       String?
  userId   Int?
  path     String // é¡µé¢è·¯å¾„ï¼Œå¦‚ "/"
  viewedAt DateTime @default(now())

  @@index([viewedAt])
  @@index([ip])
  @@index([userId])
}

model ExamResult {
  id        Int      @id @default(autoincrement())
  userId    Int
  examId    Int
  score     Int
  passed    Boolean
  createdAt DateTime @default(now())

  user User          @relation(fields: [userId], references: [id])
  exam PublishedExam @relation(fields: [examId], references: [id])
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  actionType String
  targetId   Int? // å¯ä¸ºç©º
  targetType String? // å¯ä¸ºç©º
  content    String
  isPublic   Boolean  @default(true)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// è¯¾æ—¶è¡¨ï¼šè¯¾ç¨‹çš„åŸºæœ¬æ•™å­¦å•å…ƒ
model Lesson {
  id          Int      @id @default(autoincrement())
  title       String // è¯¾æ—¶æ ‡é¢˜ï¼Œå¦‚ "HTML åŸºç¡€è¯­æ³•"
  description String? // å¯é€‰æè¿°
  courseId    Int // æ‰€å±è¯¾ç¨‹
  moduleId    Int? // å¦‚æœæœªæ¥æ”¯æŒæ¨¡å—/ç« èŠ‚ï¼Œå¯æ‰©å±•
  order       Int      @default(0) // æ’åºå­—æ®µï¼Œæ§åˆ¶è¯¾æ—¶é¡ºåº
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  type        String   @default("text")
  content     Json?    @default("[]") // ğŸ‘ˆ é»˜è®¤ç©ºæ•°ç»„// å¯Œæ–‡æœ¬å†…å®¹
  videoUrl    String? // è§†é¢‘åœ°å€
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  // module Module? @relation(fields: [moduleId], references: [id]) // æœªæ¥å¯å¯ç”¨

  // å…³è”å­¦ä¹ è¿›åº¦è®°å½•
  progresses LessonProgress[]

  @@index([courseId])
  // âœ… æ·»åŠ å¤åˆç´¢å¼•ï¼ˆå…³é”®ï¼ï¼‰
  @@index([courseId, order], name: "Lesson_courseId_order_idx")
}

// å­¦ä¹ è¿›åº¦è¡¨ï¼šè®°å½•æ¯ä¸ªç”¨æˆ·å¯¹æ¯èŠ‚è¯¾çš„å®ŒæˆçŠ¶æ€
model LessonProgress {
  id          Int       @id @default(autoincrement())
  userId      Int
  lessonId    Int
  completed   Boolean   @default(false)
  completedAt DateTime? // é¦–æ¬¡å®Œæˆæ—¶é—´ï¼ˆå¯ä¸ºç©ºï¼‰
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // â­ æ ¸å¿ƒçº¦æŸï¼šä¸€ä¸ªç”¨æˆ·å¯¹ä¸€èŠ‚è¯¾åªèƒ½æœ‰ä¸€æ¡è¿›åº¦è®°å½•
  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  content   String
  type      String // e.g., "CERTIFICATE_ISSUED", "EXAM_PASSED"
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}
