generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int           @id @default(autoincrement())
  username     String        @unique
  email        String?       @unique
  password     String
  nickname     String?
  role         String        @default("STUDENT")
  avatar       String?
  createdAt    DateTime      @default(now())
  name         String?
  courses      Course[]
  certificates Certificate[]
}

model Course {
  id           Int           @id @default(autoincrement())
  title        String        @unique // ğŸ‘ˆ æ”¹ä¸º title
  description  String?
  cover        String?
  teacherId    Int
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt // å»ºè®®åŠ ä¸Š
  teacher      User          @relation(fields: [teacherId], references: [id])
  category     String?
  certificates Certificate[]
}

model PublishedExam {
  id           Int            @id @default(autoincrement())
  title        String
  subject      String
  difficulty   String
  questionType String
  createdAt    DateTime       @default(now())
  createdBy    String
  status       String         @default("active")
  questions    ExamQuestion[]
}

model ExamQuestion {
  id              Int            @id @default(autoincrement())
  question        String
  answer          String
  explanation     String?
  createdAt       DateTime       @default(now())
  subject         String
  difficulty      String
  questionType    String
  options         Json
  optionsHash     String? // å¯é€‰ï¼Œä½†æ¨è
  publishedExam   PublishedExam? @relation(fields: [publishedExamId], references: [id])
  publishedExamId Int?
  isCurrentExam   Boolean        @default(false) // ğŸ‘ˆ æ–°å¢å­—æ®µï¼

  @@index([subject, difficulty, questionType])
  @@index([isCurrentExam]) // ğŸ‘ˆ åŠ ç´¢å¼•ï¼ŒæŸ¥è¯¢æ›´å¿«
}

model ExamTemplate {
  id       Int           @id @default(autoincrement())
  name     String        @unique
  duration Int
  sections ExamSection[]
}

model ExamSection {
  id           Int          @id @default(autoincrement())
  questionType String
  count        Int
  score        Int
  template     ExamTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId   Int
}

model Certificate {
  id         Int      @id @default(autoincrement())
  name       String? // è¯ä¹¦åç§°
  username   String // å­¦å‘˜å§“å
  courseId   Int?
  courseName String? // è¯¾ç¨‹å
  issuedAt   DateTime @default(now())
  status     String?  @default("ACTIVE") // ACTIVE, EXPIRED
  userId     Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  templateId Int
  // å…³è”å…³ç³»
  user       User     @relation(fields: [userId], references: [id])
  course     Course?  @relation(fields: [courseId], references: [id], onDelete: SetNull)
}
